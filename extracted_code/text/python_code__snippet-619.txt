"""Information regarding a progress task.

This object should be considered read-only outside of the :class:`~Progress` class.

"""

id: TaskID
"""Task ID associated with this task (used in Progress methods)."""

description: str
"""str: Description of the task."""

total: Optional[float]
"""Optional[float]: Total number of steps in this task."""

completed: float
"""float: Number of steps completed"""

_get_time: GetTimeCallable
"""Callable to get the current time."""

finished_time: Optional[float] = None
"""float: Time task was finished."""

visible: bool = True
"""bool: Indicates if this task is visible in the progress display."""

fields: Dict[str, Any] = field(default_factory=dict)
"""dict: Arbitrary fields passed in via Progress.update."""

start_time: Optional[float] = field(default=None, init=False, repr=False)
"""Optional[float]: Time this task was started, or None if not started."""

stop_time: Optional[float] = field(default=None, init=False, repr=False)
"""Optional[float]: Time this task was stopped, or None if not stopped."""

finished_speed: Optional[float] = None
"""Optional[float]: The last speed for a finished task."""

_progress: Deque[ProgressSample] = field(
    default_factory=lambda: deque(maxlen=1000), init=False, repr=False
)

_lock: RLock = field(repr=False, default_factory=RLock)
"""Thread lock."""

def get_time(self) -> float:
    """float: Get the current time, in seconds."""
    return self._get_time()

@property
def started(self) -> bool:
    """bool: Check if the task as started."""
    return self.start_time is not None

@property
def remaining(self) -> Optional[float]:
    """Optional[float]: Get the number of steps remaining, if a non-None total was set."""
    if self.total is None:
        return None
    return self.total - self.completed

@property
def elapsed(self) -> Optional[float]:
    """Optional[float]: Time elapsed since task was started, or ``None`` if the task hasn't started."""
    if self.start_time is None:
        return None
    if self.stop_time is not None:
        return self.stop_time - self.start_time
    return self.get_time() - self.start_time

@property
def finished(self) -> bool:
    """Check if the task has finished."""
    return self.finished_time is not None

@property
def percentage(self) -> float:
    """float: Get progress of task as a percentage. If a None total was set, returns 0"""
    if not self.total:
        return 0.0
    completed = (self.completed / self.total) * 100.0
    completed = min(100.0, max(0.0, completed))
    return completed

@property
def speed(self) -> Optional[float]:
    """Optional[float]: Get the estimated speed in steps per second."""
    if self.start_time is None:
        return None
    with self._lock:
        progress = self._progress
        if not progress:
            return None
        total_time = progress[-1].timestamp - progress[0].timestamp
        if total_time == 0:
            return None
        iter_progress = iter(progress)
        next(iter_progress)
        total_completed = sum(sample.completed for sample in iter_progress)
        speed = total_completed / total_time
        return speed

@property
def time_remaining(self) -> Optional[float]:
    """Optional[float]: Get estimated time to completion, or ``None`` if no data."""
    if self.finished:
        return 0.0
    speed = self.speed
    if not speed:
        return None
    remaining = self.remaining
    if remaining is None:
        return None
    estimate = ceil(remaining / speed)
    return estimate

def _reset(self) -> None:
    """Reset progress."""
    self._progress.clear()
    self.finished_time = None
    self.finished_speed = None


