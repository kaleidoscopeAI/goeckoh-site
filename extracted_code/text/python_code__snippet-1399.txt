"""
Return a string representing the user agent.
"""
data: Dict[str, Any] = {
    "installer": {"name": "pip", "version": __version__},
    "python": platform.python_version(),
    "implementation": {
        "name": platform.python_implementation(),
    },
}

if data["implementation"]["name"] == "CPython":
    data["implementation"]["version"] = platform.python_version()
elif data["implementation"]["name"] == "PyPy":
    pypy_version_info = sys.pypy_version_info  # type: ignore
    if pypy_version_info.releaselevel == "final":
        pypy_version_info = pypy_version_info[:3]
    data["implementation"]["version"] = ".".join(
        [str(x) for x in pypy_version_info]
    )
elif data["implementation"]["name"] == "Jython":
    # Complete Guess
    data["implementation"]["version"] = platform.python_version()
elif data["implementation"]["name"] == "IronPython":
    # Complete Guess
    data["implementation"]["version"] = platform.python_version()

if sys.platform.startswith("linux"):
    from pip._vendor import distro

    linux_distribution = distro.name(), distro.version(), distro.codename()
    distro_infos: Dict[str, Any] = dict(
        filter(
            lambda x: x[1],
            zip(["name", "version", "id"], linux_distribution),
        )
    )
    libc = dict(
        filter(
            lambda x: x[1],
            zip(["lib", "version"], libc_ver()),
        )
    )
    if libc:
        distro_infos["libc"] = libc
    if distro_infos:
        data["distro"] = distro_infos

if sys.platform.startswith("darwin") and platform.mac_ver()[0]:
    data["distro"] = {"name": "macOS", "version": platform.mac_ver()[0]}

if platform.system():
    data.setdefault("system", {})["name"] = platform.system()

if platform.release():
    data.setdefault("system", {})["release"] = platform.release()

if platform.machine():
    data["cpu"] = platform.machine()

if has_tls():
    import _ssl as ssl

    data["openssl_version"] = ssl.OPENSSL_VERSION

setuptools_dist = get_default_environment().get_distribution("setuptools")
if setuptools_dist is not None:
    data["setuptools_version"] = str(setuptools_dist.version)

if shutil.which("rustc") is not None:
    # If for any reason `rustc --version` fails, silently ignore it
    try:
        rustc_output = subprocess.check_output(
            ["rustc", "--version"], stderr=subprocess.STDOUT, timeout=0.5
        )
    except Exception:
        pass
    else:
        if rustc_output.startswith(b"rustc "):
            # The format of `rustc --version` is:
            # `b'rustc 1.52.1 (9bc8c42bb 2021-05-09)\n'`
            # We extract just the middle (1.52.1) part
            data["rustc_version"] = rustc_output.split(b" ")[1].decode()

# Use None rather than False so as not to give the impression that
# pip knows it is not being run under CI.  Rather, it is a null or
# inconclusive result.  Also, we include some value rather than no
# value to make it easier to know that the check has been run.
data["ci"] = True if looks_like_ci() else None

user_data = os.environ.get("PIP_USER_AGENT_USER_DATA")
if user_data is not None:
    data["user_data"] = user_data

return "{data[installer][name]}/{data[installer][version]} {json}".format(
    data=data,
    json=json.dumps(data, separators=(",", ":"), sort_keys=True),
)


