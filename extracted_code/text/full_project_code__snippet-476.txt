"""Get a lexer for a filename.

If multiple lexers match the filename pattern, use ``analyse_text()`` to
figure out which one is more appropriate.

Returns None if not found.
"""
matches = []
fn = basename(_fn)
for modname, name, _, filenames, _ in LEXERS.values():
    for filename in filenames:
        if _fn_matches(fn, filename):
            if name not in _lexer_cache:
                _load_lexers(modname)
            matches.append((_lexer_cache[name], filename))
for cls in find_plugin_lexers():
    for filename in cls.filenames:
        if _fn_matches(fn, filename):
            matches.append((cls, filename))

if isinstance(code, bytes):
    # decode it, since all analyse_text functions expect unicode
    code = guess_decode(code)

def get_rating(info):
    cls, filename = info
    # explicit patterns get a bonus
    bonus = '*' not in filename and 0.5 or 0
    # The class _always_ defines analyse_text because it's included in
    # the Lexer class.  The default implementation returns None which
    # gets turned into 0.0.  Run scripts/detect_missing_analyse_text.py
    # to find lexers which need it overridden.
    if code:
        return cls.analyse_text(code) + bonus, cls.__name__
    return cls.priority + bonus, cls.__name__

if matches:
    matches.sort(key=get_rating)
    # print "Possible lexers, after sort:", matches
    return matches[-1][0]


