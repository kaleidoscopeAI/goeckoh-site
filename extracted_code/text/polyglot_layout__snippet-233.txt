  id2sum = fetch_summaries(db_path)
  by_t: Dict[int, List[Tuple[List[int], List[float]]]] = {}; T = 0
  for rec in shapes["shapes"]:
      t = int(rec["t"]); T = max(T, t + 1)
      by_t.setdefault(t, []).append((rec["ids"], rec["weights"]))
  caps = []; t0 = 0
  while t0 < T:
      t1 = min(T - 1, t0 + window - 1)
      score: Dict[int, float] = {}; denom = 0.0
      for t in range(t0, t1 + 1):
          for ids, wts in by_t.get(t, []):

