"""
As :func:`guess_lexer()`, but only lexers which have a pattern in `filenames`
or `alias_filenames` that matches `filename` are taken into consideration.

:exc:`pygments.util.ClassNotFound` is raised if no lexer thinks it can
handle the content.
"""
fn = basename(_fn)
primary = {}
matching_lexers = set()
for lexer in _iter_lexerclasses():
    for filename in lexer.filenames:
        if _fn_matches(fn, filename):
            matching_lexers.add(lexer)
            primary[lexer] = True
    for filename in lexer.alias_filenames:
        if _fn_matches(fn, filename):
            matching_lexers.add(lexer)
            primary[lexer] = False
if not matching_lexers:
    raise ClassNotFound('no lexer for filename %r found' % fn)
if len(matching_lexers) == 1:
    return matching_lexers.pop()(**options)
result = []
for lexer in matching_lexers:
    rv = lexer.analyse_text(_text)
    if rv == 1.0:
        return lexer(**options)
    result.append((rv, lexer))

def type_sort(t):
    # sort by:
    # - analyse score
    # - is primary filename pattern?
    # - priority
    # - last resort: class name
    return (t[0], primary[t[1]], t[1].priority, t[1].__name__)
result.sort(key=type_sort)

return result[-1][1](**options)


