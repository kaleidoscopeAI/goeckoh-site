mapping = state.mapping
all_keys = {id(v): k for k, v in mapping.items()}
all_keys[id(None)] = None

graph = DirectedGraph()
graph.add(None)  # Sentinel as root dependencies' parent.

connected = {None}
for key, criterion in state.criteria.items():
    if not _has_route_to_root(state.criteria, key, all_keys, connected):
        continue
    if key not in graph:
        graph.add(key)
    for p in criterion.iter_parent():
        try:
            pkey = all_keys[id(p)]
        except KeyError:
            continue
        if pkey not in graph:
            graph.add(pkey)
        graph.connect(pkey, key)

return Result(
    mapping={k: v for k, v in mapping.items() if k in connected},
    graph=graph,
    criteria=state.criteria,
)


