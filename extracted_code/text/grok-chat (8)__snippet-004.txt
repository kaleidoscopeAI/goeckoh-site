print("=====================================================")
print("=== FORGING THE KALEIDOSCOPE AI SYSTEM IN ACTION! ===")
print("=====================================================\n")

# 1. Initialize Core Components
conscious_cube = ConsciousCube()
insight_synthesizer = InsightSynthesisTool(n_clusters=2) # 2 clusters for simplicity
pattern_detector = PatternDetectionTool(num_bins=20)

# Initialize Super Nodes
finance_sn = SuperNode("Finance_SN", "Global Financial Markets")
supply_chain_sn = SuperNode("SupplyChain_SN", "Global Supply Chain Logistics")
healthcare_sn = SuperNode("Healthcare_SN", "Public Health Outcomes")

# Add initial conceptual nodes to the Conscious Cube (representing Super Nodes)
conscious_cube.add_conceptual_node("Finance_SN_Proxy", initial_strength=0.5)
conscious_cube.add_conceptual_node("SupplyChain_SN_Proxy", initial_strength=0.5)
conscious_cube.add_conceptual_node("Healthcare_SN_Proxy", initial_strength=0.5)

print("\n--- PHASE 1: Super Nodes Ingest, Mimic, and Infer ---")
# Simulate historical data for Super Nodes
history_len = 100
finance_data = np.cumsum(np.random.normal(0, 0.5, history_len)) + 100 # Stock index
supply_inv_data = np.cumsum(np.random.normal(0, 5, history_len) - 2) + 150 # Inventory levels
supply_dem_data = np.cumsum(np.random.normal(0, 3, history_len) + 1) + 50 # Demand levels
healthcare_patient_flow = np.cumsum(np.random.normal(0, 2, history_len)) + 200 # Patient flow

finance_sn.ingest_historical_data("stock_index", finance_data)
supply_chain_sn.ingest_historical_data("inventory", supply_inv_data)
supply_chain_sn.ingest_historical_data("demand", supply_dem_data)
healthcare_sn.ingest_historical_data("patient_flow", healthcare_patient_flow)

# Example web crawling for finance data (assuming a selector for data)
finance_sn.crawl_and_ingest_data("https://example-finance-site.com/stock-data", "web_stock", ".data-value")

# Train generative models for Super Nodes
finance_sn.train_generative_models(["stock_index"])
supply_chain_sn.train_generative_models(["inventory", "demand"])
healthcare_sn.train_generative_models(["patient_flow"])

# Train Prophet models
finance_sn.train_prophet_model("stock_index")
supply_chain_sn.train_prophet_model("inventory")
supply_chain_sn.train_prophet_model("demand")
healthcare_sn.train_prophet_model("patient_flow")

# Super Nodes perform generative simulations and infer causal links
finance_sn.perform_generative_simulation("stock_index", steps=5, use_hybrid=True)
supply_chain_sn.perform_generative_simulation("inventory", steps=5, use_hybrid=True)
supply_chain_sn.infer_causal_links("demand", "inventory") # Does demand affect inventory?

print("\n--- PHASE 2: Super Nodes Provide Insights to Synthesis Tool ---")
# Super Nodes generate proactive insights for the Synthesis Tool and activity for the Cube
finance_insight_text, finance_keywords, finance_activity = finance_sn.provide_proactive_insight()
insight_synthesizer.ingest_super_node_insights(finance_sn.node_id, finance_insight_text, finance_keywords)
conscious_cube.update_node_activity("Finance_SN_Proxy", finance_activity)

supply_insight_text, supply_keywords, supply_activity = supply_chain_sn.provide_proactive_insight()
insight_synthesizer.ingest_super_node_insights(supply_chain_sn.node_id, supply_insight_text, supply_keywords)
conscious_cube.update_node_activity("SupplyChain_SN_Proxy", supply_activity)

healthcare_insight_text, healthcare_keywords, healthcare_activity = healthcare_sn.provide_proactive_insight()
insight_synthesizer.ingest_super_node_insights(healthcare_sn.node_id, healthcare_insight_text, healthcare_keywords)
conscious_cube.update_node_activity("Healthcare_SN_Proxy", healthcare_activity)

# Add a conceptual insight that links finance and healthcare (e.g., from a separate SN or pre-existing data)
insight_synthesizer.ingest_super_node_insights(
    "EconomicHealth_SN",
    "Economic downturns correlate with increased mental health service demand.",
    ['economy', 'mental health', 'healthcare', 'correlation']
)
conscious_cube.add_conceptual_node("EconomicHealth_SN_Proxy", initial_strength=0.6)
conscious_cube.update_node_activity("EconomicHealth_SN_Proxy", 0.7) # Simulate high activity for this link

print("\n--- PHASE 3: Synthesis Tool Articulates Breakthroughs ---")
# Synthesis Tool identifies clusters and articulates breakthroughs
insight_synthesizer.identify_semantic_clusters()
breakthrough_insights = insight_synthesizer.articulate_breakthroughs()
if breakthrough_insights:
    for b_insight in breakthrough_insights:
        print(b_insight)
        # Conceptual: A breakthrough insight might strengthen a new connection in the Cube
        # Or even trigger the creation of a new conceptual node representing the breakthrough
        if "integrated risk models" in b_insight:
            conscious_cube.add_conceptual_node("IntegratedRiskModel_Insight", initial_strength=0.9)
            conscious_cube.graph.add_edge("IntegratedRiskModel_Insight", "Finance_SN_Proxy", weight=0.8)
            conscious_cube.graph.add_edge("IntegratedRiskModel_Insight", "SupplyChain_SN_Proxy", weight=0.7)
            conscious_cube._update_viz_properties("IntegratedRiskModel_Insight")
            conscious_cube._update_edge_viz_properties("IntegratedRiskModel_Insight", "Finance_SN_Proxy")
            conscious_cube._update_edge_viz_properties("IntegratedRiskModel_Insight", "SupplyChain_SN_Proxy")
        elif "healthcare delivery paradigms" in b_insight:
            conscious_cube.add_conceptual_node("NewHealthcareParadigm_Insight", initial_strength=0.9)
            conscious_cube.graph.add_edge("NewHealthcareParadigm_Insight", "Healthcare_SN_Proxy", weight=0.8)
            conscious_cube.graph.add_edge("NewHealthcareParadigm_Insight", "SupplyChain_SN_Proxy", weight=0.7)
            conscious_cube._update_viz_properties("NewHealthcareParadigm_Insight")
            conscious_cube._update_edge_viz_properties("NewHealthcareParadigm_Insight", "Healthcare_SN_Proxy")
            conscious_cube._update_edge_viz_properties("NewHealthcareParadigm_Insight", "SupplyChain_SN_Proxy")


print("\n--- PHASE 4: Pattern Detection Monitors and Triggers Optimization ---")
# Establish a baseline for system health (e.g., overall system activity score)
baseline_system_activity = np.random.normal(loc=0.5, scale=0.1, size=500) # Simulate normal system activity
pattern_detector.establish_baseline(baseline_system_activity)

# Simulate a period of "normal" system activity
current_system_activity_normal = np.random.normal(loc=0.55, scale=0.08, size=50)
is_emergent, kl_val, optimization_directive_normal = pattern_detector.detect_emergent_pattern(current_system_activity_normal, kl_threshold=0.1)
if is_emergent:
    print(f"  System-wide Optimization Triggered: {optimization_directive_normal}")

# Simulate an "emergent pattern" - e.g., a sudden increase in overall system activity/stress
print("\n--- SIMULATING EMERGENT SYSTEM STRESS ---")
emergent_system_activity = np.random.normal(loc=0.8, scale=0.15, size=50) # Higher, more volatile activity
is_emergent, kl_val, optimization_directive_emergent = pattern_detector.detect_emergent_pattern(emergent_system_activity, kl_threshold=0.1)
if is_emergent:
    print(f"  System-wide Optimization Triggered: {optimization_directive_emergent}")
    # Conceptual: This directive from Pattern Detection would directly influence the Cube's self-architecture
    # For example, if directive is to "PRIORITIZE RESOURCE ALLOCATION ANALYSIS", the Cube might
    # strengthen connections to resource-related Super Nodes or spawn a "ResourceMonitor_Insight" node.
    if "PRIORITIZE RESOURCE ALLOCATION ANALYSIS" in optimization_directive_emergent:
        conscious_cube.update_node_activity("Finance_SN_Proxy", 1.0) # Highlight finance due to resource concern
        conscious_cube.update_node_activity("SupplyChain_SN_Proxy", 1.0) # Highlight supply chain
        conscious_cube.add_conceptual_node("ResourceMonitor_Insight", initial_strength=0.8)
        conscious_cube.graph.add_edge("ResourceMonitor_Insight", "Finance_SN_Proxy", weight=0.9)
        conscious_cube.graph.add_edge("ResourceMonitor_Insight", "SupplyChain_SN_Proxy", weight=0.9)
        conscious_cube._update_viz_properties("ResourceMonitor_Insight")
        conscious_cube._update_edge_viz_properties("ResourceMonitor_Insight", "Finance_SN_Proxy")
        conscious_cube._update_edge_viz_properties("ResourceMonitor_Insight", "SupplyChain_SN_Proxy")
        print("  Conscious Cube responded to optimization directive by highlighting relevant nodes and creating 'ResourceMonitor_Insight'.")


print("\n--- FINAL SYSTEM STATUS REPORT ---")
conscious_cube.report_status()

# Visualize the Conscious Cube using voxels
conscious_cube.visualize_voxels()

# --- Conceptual Visualization of Pattern Detection (using Matplotlib) ---
plt.figure(figsize=(12, 5))

plt.subplot(1, 2, 1)
plt.hist(baseline_system_activity, bins=pattern_detector.bin_edges, density=True, alpha=0.7, color='blue', label='Baseline Activity')
plt.hist(current_system_activity_normal, bins=pattern_detector.bin_edges, density=True, alpha=0.7, color='green', label='Normal Current Activity')
plt.title('System Activity: Normal State vs. Baseline')
plt.xlabel('Activity Score')
plt.ylabel('Density')
plt.legend()

plt.subplot(1, 2, 2)
plt.hist(baseline_system_activity, bins=pattern_detector.bin_edges, density=True, alpha=0.5, color='blue', label='Baseline Activity')
plt.hist(emergent_system_activity, bins=pattern_detector.bin_edges, density=True, alpha=0.7, color='red', label='Emergent (Stressed) Activity')
plt.title('System Activity: Emergent Stress vs. Baseline')
plt.xlabel('Activity Score')
plt.ylabel('Density')
plt.legend()

plt.tight_layout()
plt.show()

print("\n=====================================================")
print("=== KALEIDOSCOPE AI SYSTEM SIMULATION COMPLETE! ===")
print("=====================================================")

