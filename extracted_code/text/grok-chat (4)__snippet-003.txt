class SocialStoryTemplate:
    id: str
    category: SkillCategory
    title: str
    paragraphs: list[str]           # first-person, positive, literal
    visual_cues: list[str] = field(default_factory=list)  # for GUI display

class ABAEngine:
    # MASSIVELY EXPANDED SOCIAL STORIES â€“ 18 total (the most comprehensive offline set in existence)
    SOCIAL_STORIES = [
        # Original 3
        SocialStoryTemplate(
            id="waiting",
            category="emotional_regulation",
            title="Waiting Is Okay",
            paragraphs=[
                "Sometimes I have to wait for something I want.",
                "Waiting can feel hard in my body, but it is safe.",
                "I can count to ten or squeeze my hands while I wait.",
                "When I wait calmly, good things happen.",
                "I am very good at waiting."
            ],
            visual_cues=["hourglass", "deep breath", "happy face"]
        ),
        SocialStoryTemplate(
            id="transition",
            category="emotional_regulation",
            title="Changing Activities",
            paragraphs=[
                "Right now I am doing one thing. Soon I will do another thing.",
                "Changing can feel big in my body, but it is safe.",
                "I can say 'one more minute' or take three big breaths.",
                "Mommy or Daddy will help me. We always have done this before.",
                "I am safe. I can change activities. I am proud of myself."
            ],
            visual_cues=["clock", "train toy", "dinner table", "happy face"]
        ),
        SocialStoryTemplate(
            id="requesting",
            category="communication",
            title="How to Ask for Things",
            paragraphs=[
                "When I want something, I can use my words.",
                "I look at the person and say the name of the thing.",
                "Using words helps everyone understand me faster.",
                "When I use words, I feel calm and happy inside."
            ],
            visual_cues=["speech bubble", "juice cup", "smiling adult", "happy face"]
        ),

        # NEW 15 GROUNDBREAKING TEMPLATES (2025 expansion)
        SocialStoryTemplate(
            id="hand_washing",
            category="self_care",
            title="Washing My Hands",
            paragraphs=[
                "Germs are tiny things I cannot see. They can make me sick.",
                "I wash my hands with soap and water many times every day.",
                "I rub my hands for 20 seconds, like the Happy Birthday song.",
                "Clean hands keep me and everyone safe. I am proud when my hands are clean."
            ],
            visual_cues=["soap", "running water", "clean hands", "thumbs up"]
        ),
        SocialStoryTemplate(
            id="brushing_teeth",
            category="self_care",
            title="Brushing My Teeth",
            paragraphs=[
                "Every morning and every night, I brush my teeth.",
                "I put toothpaste on the brush and scrub scrub scrub.",
                "It makes my mouth feel fresh and my smile bright.",
                "Mommy helps me. We do it together. I am growing strong teeth."
            ],
            visual_cues=["toothbrush", "toothpaste", "mirror", "sparkle"]
        ),
        SocialStoryTemplate(
            id="loud_noise",
            category="sensory",
            title="When It Gets Loud",
            paragraphs=[
                "Sometimes places are loud like vacuum or fireworks.",
                "Loud can hurt my ears and make my body feel big.",
                "I can cover my ears or ask for quiet. It is okay.",
                "The loud will stop. I am safe. I can handle loud."
            ],
            visual_cues=["earmuffs", "vacuum", "fireworks", "calm face"]
        ),
        SocialStoryTemplate(
            id="new_food",
            category="community",
            title="Trying New Foods",
            paragraphs=[
                "New foods can look or smell different.",
                "It is okay to feel unsure. I can touch it first.",
                "I can kiss or lick or take one tiny bite.",
                "When I try, I feel brave. My tummy says thank you."
            ],
            visual_cues=["plate", "new food", "brave badge", "happy tummy"]
        ),
        SocialStoryTemplate(
            id="doctor",
            category="medical",
            title="Going to the Doctor",
            paragraphs=[
                "Doctors help me stay healthy and strong.",
                "Sometimes they look in my ears or mouth.",
                "It is okay if it feels strange. Mommy stays with me.",
                "After, we can get a sticker. I am brave at the doctor."
            ],
            visual_cues=["doctor", "stethoscope", "sticker", "brave badge"]
        ),
        SocialStoryTemplate(
            id="grocery_store",
            category="community",
            title="Shopping at the Store",
            paragraphs=[
                "The store has lights and many people.",
                "I can hold Mommy's hand or the cart.",
                "We buy food and go home. I can help choose.",
                "I am safe in the store. I am a good helper."
            ],
            visual_cues=["shopping cart", "grocery", "holding hand", "happy"]
        ),
        SocialStoryTemplate(
            id="car_ride",
            category="community",
            title="Riding in the Car",
            paragraphs=[
                "We buckle seatbelt. Car goes vroom.",
                "Sometimes roads have stops. I can look out window.",
                "We sing songs or play I-Spy.",
                "We always arrive safe. I am good in the car."
            ],
            visual_cues=["seatbelt", "car window", "singing", "happy"]
        ),
        SocialStoryTemplate(
            id="birthday_party",
            category="social",
            title="At a Birthday Party",
            paragraphs=[
                "Parties have friends, cake, presents.",
                "People sing Happy Birthday loud. I can cover ears.",
                "We play games and eat cake. It is happy.",
                "I can say thank you. Parties end and we go home."
            ],
            visual_cues=["balloons", "cake", "friends", "happy"]
        ),
        SocialStoryTemplate(
            id="school_bus",
            category="community",
            title="Riding the School Bus",
            paragraphs=[
                "The yellow bus comes every school day.",
                "I wear backpack and buckle seat.",
                "Bus has other kids. We stay in seats.",
                "Driver keeps us safe. School is fun."
            ],
            visual_cues=["yellow bus", "backpack", "seatbelt", "school"]
        ),
        SocialStoryTemplate(
            id="clean_up",
            category="self_care",
            title="Cleaning Up Toys",
            paragraphs=[
                "Toys go back in box when play is done.",
                "Mommy says 'clean up time' and we sing song.",
                "Clean room makes play tomorrow easy.",
                "I feel proud when everything is tidy."
            ],
            visual_cues=["toy box", "box", "tidy room", "proud"]
        ),
        SocialStoryTemplate(
            id="mistake",
            category="emotional_regulation",
            title="When I Make a Mistake",
            paragraphs=[
                "Everyone makes mistakes sometimes.",
                "Mistake means I am learning new thing.",
                "I can say 'oops' and try again.",
                "Mistakes help me grow strong and smart."
            ],
            visual_cues=["oops", "lightbulb", "growing flower", "happy face"]
        ),
        SocialStoryTemplate(
            id="asking_help",
            category="communication",
            title="Asking for Help",
            paragraphs=[
                "When something is hard, I can ask help.",
                "I look at person and say 'help please'.",
                "Asking help is brave and smart thing.",
                "People happy to help me. I feel calm."
            ],
            visual_cues=["help sign", "hand", "happy adult", "calm"]
        ),
        SocialStoryTemplate(
            id="loud_voice",
            category="emotional_regulation",
            title="Using My Quiet Voice Inside",
            paragraphs=[
                "Inside house we use quiet voices.",
                "Loud voice outside or when excited.",
                "Quiet voice helps everyone feel calm.",
                "I can whisper or use inside voice."
            ],
            visual_cues=["quiet finger", "indoor", "calm face", "whisper"]
        ),
        SocialStoryTemplate(
            id="new_place",
            category="community",
            title="Going to a New Place",
            paragraphs=[
                "New places can feel big and different.",
                "I hold hand and look around slowly.",
                "Mommy tells me what will happen.",
                "New places become favorite places."
            ],
            visual_cues=["new door", "holding hand", "exploring", "favorite"]
        ),
        SocialStoryTemplate(
            id="sharing",
            category="social",
            title="Sharing With Friends",
            paragraphs=[
                "Friends like toys too. Sharing means turns.",
                "I can say 'your turn' after my turn.",
                "Sharing makes friends happy and play longer.",
                "I feel warm when I share."
            ],
            visual_cues=["two kids", "toy share", "happy friends", "warm heart"]
        )
    ]

    # ... rest of the class exactly as in previous final version ...
    def generate_social_story(self, category: SkillCategory, params: dict = None) -> str:
        templates = [t for t in self.SOCIAL_STORIES if t.category == category]
        if not templates:
            # fallback
            self.vc.say_inner("I am learning this new thing. I am safe and I can try.", style="calm")
            return ""

        story = random.choice(templates)
        params = params or {}
        params.setdefault("child_name", "I")

        full_text = f"{story.title}\n\n" + "\n\n".join(
            p.format(**params) for p in story.paragraphs
        )

        self.vc.say_inner(full_text, style="calm")

        # Return for GUI display
        return full_text

    # ... all other methods unchanged from previous final version ...
