ppChainContext = None
try:
    # Get cert chain
    ppChainContext = pointer(PCERT_CHAIN_CONTEXT())
    CertGetCertificateChain(
        hChainEngine,  # chain engine
        pPeerCertContext,  # leaf cert context
        None,  # current system time
        hIntermediateCertStore,  # additional in-memory cert store
        pChainPara,  # chain-building parameters
        chain_flags,
        None,  # reserved
        ppChainContext,  # the resulting chain context
    )
    pChainContext = ppChainContext.contents

    # Verify cert chain
    ssl_extra_cert_chain_policy_para = SSL_EXTRA_CERT_CHAIN_POLICY_PARA()
    ssl_extra_cert_chain_policy_para.cbSize = sizeof(
        ssl_extra_cert_chain_policy_para
    )
    ssl_extra_cert_chain_policy_para.dwAuthType = AUTHTYPE_SERVER
    ssl_extra_cert_chain_policy_para.fdwChecks = 0
    if server_hostname:
        ssl_extra_cert_chain_policy_para.pwszServerName = c_wchar_p(server_hostname)

    chain_policy = CERT_CHAIN_POLICY_PARA()
    chain_policy.pvExtraPolicyPara = cast(
        pointer(ssl_extra_cert_chain_policy_para), c_void_p
    )
    if ssl_context.verify_mode == ssl.CERT_NONE:
        chain_policy.dwFlags |= CERT_CHAIN_POLICY_VERIFY_MODE_NONE_FLAGS
    if not ssl_context.check_hostname:
        chain_policy.dwFlags |= CERT_CHAIN_POLICY_IGNORE_INVALID_NAME_FLAG
    chain_policy.cbSize = sizeof(chain_policy)

    pPolicyPara = pointer(chain_policy)
    policy_status = CERT_CHAIN_POLICY_STATUS()
    policy_status.cbSize = sizeof(policy_status)
    pPolicyStatus = pointer(policy_status)
    CertVerifyCertificateChainPolicy(
        CERT_CHAIN_POLICY_SSL,
        pChainContext,
        pPolicyPara,
        pPolicyStatus,
    )

    # Check status
    error_code = policy_status.dwError
    if error_code:
        # Try getting a human readable message for an error code.
        error_message_buf = create_unicode_buffer(1024)
        error_message_chars = FormatMessageW(
            FORMAT_MESSAGE_FROM_SYSTEM | FORMAT_MESSAGE_IGNORE_INSERTS,
            None,
            error_code,
            0,
            error_message_buf,
            sizeof(error_message_buf),
            None,
        )

        # See if we received a message for the error,
        # otherwise we use a generic error with the
        # error code and hope that it's search-able.
        if error_message_chars <= 0:
            error_message = f"Certificate chain policy error {error_code:#x} [{policy_status.lElementIndex}]"
        else:
            error_message = error_message_buf.value.strip()

        err = ssl.SSLCertVerificationError(error_message)
        err.verify_message = error_message
        err.verify_code = error_code
        raise err from None
finally:
    if ppChainContext:
        CertFreeCertificateChain(ppChainContext.contents)


