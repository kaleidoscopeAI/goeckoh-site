"""
Complete Daily Routine Assistance Engine
- APScheduler cron jobs (runs forever, survives restarts via persisted JSON)
- Weather & disruption aware (parent sets daily via dashboard → saved to today_notes.json)
- Emotion-aware prompting (calm style if anxious/high_energy)
- Medication logging (marks as reminded; parent confirms taken in dashboard)
- First-person inner voice whenever possible
- Fully editable by parent (GUI writes to routines.json)
"""

DEFAULT_ROUTINES = [
    {
        "id": "wake_up",
        "name": "Morning Wake-Up",
        "trigger_time": "07:00",
        "message_base": "Good morning! It's time to wake up and have a wonderful day.",
        "weather_adjustments": {"rainy": "", "cold": " It's cold outside today. Let's wear warm clothes."}
    },
    {
        "id": "brush_teeth_morning",
        "name": "Morning Teeth Brushing",
        "trigger_time": "07:20",
        "message_base": "Time to brush my teeth and feel fresh!"
    },
    {
        "id": "medication_morning",
        "name": "Morning Medication",
        "type": "medication",
        "trigger_time": "07:30",
        "message_base": "Time for my morning medicine. I'll feel better after."
    },
    {
        "id": "school_prep",
        "name": "Get Ready for School",
        "trigger_time": "07:45",
        "message_base": "Let's pack my backpack and put on shoes. The school bus comes soon!"
    },
    {
        "id": "screen_time_end",
        "name": "Screen Time Over",
        "trigger_time": "19:00",
        "message_base": "Screen time is finished for today. Let's do something fun together now."
    },
    {
        "id": "bedtime_routine",
        "name": "Bedtime Routine",
        "trigger_time": "20:00",
        "message_base": "It's bedtime soon. Let's put on pajamas, read a book, and get cozy."
    },
    {
        "id": "goodnight",
        "name": "Good Night",
        "trigger_time": "20:30",
        "message_base": "Good night. I am safe. I am loved. Sweet dreams."
    }
]

def __init__(self, voice_crystal: VoiceCrystal, config, behavior_monitor: Optional[BehaviorMonitor] = None):
    self.vc = voice_crystal
    self.config = config
    self.bm = behavior_monitor

    self.routines_path = config.paths.base / "routines.json"
    self.today_notes_path = config.paths.base / "today_notes.json"

    self.scheduler = BackgroundScheduler(timezone="local")
    self.routines: list[RoutineItem] = []

    self._load_routines()
    self._load_today_notes()
    self._schedule_all()

    # Start scheduler (will persist across app restarts because jobs are re-added on init)
    if not self.scheduler.running:
        self.scheduler.start()

def _load_routines(self) -> None:
    if self.routines_path.exists():
        try:
            data = json.loads(self.routines_path.read_text())
            self.routines = [RoutineItem(**item) for item in data]
            return
        except Exception:
            pass  # fall back to defaults

    # First-time setup – create defaults
    self.routines = [RoutineItem(**item) for item in self.DEFAULT_ROUTINES]
    self.save_routines()

def _load_today_notes(self) -> None:
    default = {"weather": "sunny", "special_note": "", "disruptions": []}
    if self.today_notes_path.exists():
        try:
            self.today_notes = json.loads(self.today_notes_path.read_text())
            return
        except Exception:
            pass
    self.today_notes = default
    self.today_notes_path.write_text(json.dumps(default, indent=2))

def save_routines(self) -> None:
    data = [r.__dict__ for r in self.routines]
    self.routines_path.write_text(json.dumps(data, indent=2))

def set_today_weather(self, weather: str) -> None:
    self.today_notes["weather"] = weather.lower()
    self.today_notes_path.write_text(json.dumps(self.today_notes, indent=2))

def set_special_note(self, note: str) -> None:
    self.today_notes["special_note"] = note
    self.today_notes_path.write_text(json.dumps(self.today_notes, indent=2))

def _schedule_all(self) -> None:
    # Clear existing jobs to avoid duplicates on restart
    self.scheduler.remove_all_jobs()

    for routine in self.routines:
        if not routine.enabled:
            continue

        hour, minute = map(int, routine.trigger_time.split(":"))

        self.scheduler.add_job(
            func=self._trigger_routine,
            trigger=CronTrigger(hour=hour, minute=minute, timezone="local"),
            id=routine.id,
            name=routine.name,
            args=[routine]
        )

def _trigger_routine(self, routine: RoutineItem) -> None:
    if not routine.enabled:
        return

    # Build message with context
    message = routine.message_base

    # Weather adjustment
    weather = self.today_notes.get("weather", "sunny")
    if routine.weather_adjustments and weather in routine.weather_adjustments:
        message += routine.weather_adjustments[weather]

    # Special note
    if routine.disruption_note_key and self.today_notes.get("special_note"):
        message += " " + self.today_notes["special_note"]

    # Emotion-aware style
    style: Style = "neutral"
    if self.bm:
        if self.bm.current_state in ["anxious", "high_energy", "meltdown_risk"]:
            style = "calm"
            message = "It's okay. Take a deep breath. " + message
        elif "good" in message.lower() or "wonderful" in message.lower():
            style = "excited"

    # Speak in child's own voice (inner voice for gentle prompts, outer for urgent)
    self.vc.say_inner(message, style=style)

    # Log medication reminder
    if routine.type == "medication":
        routine.last_triggered = datetime.now().date().isoformat()
        self.save_routines()

# Public API for GUI
def add_routine(self, routine_data: dict) -> None:
    new_id = routine_data.get("id") or routine_data["name"].lower().replace(" ", "_")
    routine_data["id"] = new_id
    self.routines.append(RoutineItem(**routine_data))
    self.save_routines()
    self._schedule_all()

def update_routine(self, routine_id: str, updates: dict) -> None:
    for r in self.routines:
        if r.id == routine_id:
            for k, v in updates.items():
                setattr(r, k, v)
            break
    self.save_routines()
    self._schedule_all()

def delete_routine(self, routine_id: str) -> None:
    self.routines = [r for r in self.routines if r.id != routine_id]
    self.save_routines()
    self._schedule_all()

def get_all_routines(self) -> list[dict]:
    return [r.__dict__ for r in self.routines]

def get_today_notes(self) -> dict:
    return self.today_notes

# Graceful shutdown (call from main.py on exit if needed)
def shutdown(self):
    if self.scheduler.running:
        self.scheduler.shutdown()

