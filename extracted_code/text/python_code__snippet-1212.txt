"""Access an Simple API response with GET, and return the response.

This consists of three parts:

1. If the URL looks suspiciously like an archive, send a HEAD first to
   check the Content-Type is HTML or Simple API, to avoid downloading a
   large file. Raise `_NotHTTP` if the content type cannot be determined, or
   `_NotAPIContent` if it is not HTML or a Simple API.
2. Actually perform the request. Raise HTTP exceptions on network failures.
3. Check the Content-Type header to make sure we got a Simple API response,
   and raise `_NotAPIContent` otherwise.
"""
if is_archive_file(Link(url).filename):
    _ensure_api_response(url, session=session)

logger.debug("Getting page %s", redact_auth_from_url(url))

resp = session.get(
    url,
    headers={
        "Accept": ", ".join(
            [
                "application/vnd.pypi.simple.v1+json",
                "application/vnd.pypi.simple.v1+html; q=0.1",
                "text/html; q=0.01",
            ]
        ),
        # We don't want to blindly returned cached data for
        # /simple/, because authors generally expecting that
        # twine upload && pip install will function, but if
        # they've done a pip install in the last ~10 minutes
        # it won't. Thus by setting this to zero we will not
        # blindly use any cached data, however the benefit of
        # using max-age=0 instead of no-cache, is that we will
        # still support conditional requests, so we will still
        # minimize traffic sent in cases where the page hasn't
        # changed at all, we will just always incur the round
        # trip for the conditional GET now instead of only
        # once per 10 minutes.
        # For more information, please see pypa/pip#5670.
        "Cache-Control": "max-age=0",
    },
)
raise_for_status(resp)

# The check for archives above only works if the url ends with
# something that looks like an archive. However that is not a
# requirement of an url. Unless we issue a HEAD request on every
# url we cannot know ahead of time for sure if something is a
# Simple API response or not. However we can check after we've
# downloaded it.
_ensure_api_header(resp)

logger.debug(
    "Fetched page %s as %s",
    redact_auth_from_url(url),
    resp.headers.get("Content-Type", "Unknown"),
)

return resp


