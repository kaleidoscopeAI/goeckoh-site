let chart=null;
async function fetchJSON(url){const res=await fetch(url); if(!res.ok) return null; return await res.json();}
function updateLive(data){document.getElementById("live-ts").textContent=data.timestamp_iso?`Last utterance at ${data.timestamp_iso}`:"No data yet."; document.getElementById("live-raw").textContent=data.raw_text||"—"; document.getElementById("live-corrected").textContent=data.corrected_text||"—"; document.getElementById("m-arousal").textContent=((data.arousal??0)).toFixed(2); document.getElementById("m-valence").textContent=((data.valence??0)).toFixed(2); document.getElementById("m-temp").textContent=((data.temperature??0)).toFixed(3); document.getElementById("m-coh").textContent=((data.coherence??0)).toFixed(3);}
function updateStats(stats){const labels=[]; const values=[]; const rows=[]; Object.entries(stats).forEach(([phrase,s])=>{labels.push(phrase||"<empty>"); values.push(s.correction_rate||0); rows.push({phrase:phrase||"<empty>", attempts:s.attempts||0, corrections:s.corrections||0, rate:s.correction_rate||0});}); const ctx=document.getElementById("phraseChart").getContext("2d"); if(chart){chart.data.labels=labels; chart.data.datasets[0].data=values; chart.update();} else {chart=new Chart(ctx,{type:"bar",data:{labels:labels,datasets:[{label:"Correction rate",data:values}]},options:{scales:{y:{min:0,max:1}}}});} const tbody=document.querySelector("#phraseTable tbody"); tbody.innerHTML=""; rows.sort((a,b)=>b.rate-a.rate).slice(0,15).forEach(r=>{const tr=document.createElement("tr"); tr.innerHTML=`<td>${r.phrase}</td><td>${r.attempts}</td><td>${r.corrections}</td><td>${(r.rate*100).toFixed(1)}%</td>`; tbody.appendChild(tr);});}
async function tick(){const live=await fetchJSON("/api/latest"); if(live) updateLive(live); const stats=await fetchJSON("/api/stats"); if(stats) updateStats(stats);} setInterval(tick,2000); tick();
