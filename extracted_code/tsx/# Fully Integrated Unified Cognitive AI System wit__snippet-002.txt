import React, { useRef, useEffect, useState } from 'react';

interface NodeData {
  vector: number[]; // e.g. length 3 or more
  arousal: number;
  valence: number;
}

interface ThoughtImageProps {
  nodes: NodeData[];
  width: number;
  height: number;
}

const ThoughtImage: React.FC<ThoughtImageProps> = ({ nodes, width, height }) => {
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const [imageData, setImageData] = useState<Uint8ClampedArray>();

  useEffect(() => {
    if (!nodes.length) return;
    const data = new Uint8ClampedArray(width * height * 4);

    nodes.forEach((node, i) => {
      const idx = i * 4;
      // Map first 3 vector components to RGB (normalized 0-255)
      for (let j = 0; j < 3; j++) {
        let val = node.vector[j];
        val = Math.min(1, Math.max(0, val)); // clamp between 0 and 1
        data[idx + j] = Math.floor(val * 255);
      }

      // Alpha from arousal (scaled)
      data[idx + 3] = Math.floor(Math.min(1, Math.max(0, node.arousal)) * 255);
    });

    setImageData(data);
  }, [nodes, width, height]);

  useEffect(() => {
    if (!canvasRef.current || !imageData) return;
    const ctx = canvasRef.current.getContext("2d");
    if (!ctx) return;

    const imgData = new ImageData(imageData, width, height);
    ctx.putImageData(imgData, 0, 0);
  }, [imageData, width, height]);

  return <canvas ref={canvasRef} width={width} height={height} style={{ imageRendering: 'pixelated', border: '1px solid #222' }}/>;
};

export default ThoughtImage;
